<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sugar Kane Rhythm Game</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: monospace;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: auto;
      background: #111;
    }
    .ui {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 6px;
    }
    .ui input, .ui button, .ui textarea {
      margin-top: 5px;
      width: 100%;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      object-fit: cover;
      width: 100%;
      height: 100%;
      z-index: -1;
      filter: grayscale(1);
    }
  </style>
</head>
<body>

<video autoplay muted loop playsinline>
  <source src="Sugar Kane - Sonic Youth.mp4" type="video/mp4">
</video>

<canvas id="gameCanvas" width="600" height="700"></canvas>
<div class="ui">
  Volume:<input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
  Judge:<input type="range" id="judge" min="10" max="150" value="50">
  <button onclick="togglePause()">‚è∏ Pause</button>
  <textarea id="commentBox" placeholder="Leave comment..."></textarea>
  <button onclick="saveComment()">üí¨ Save</button>
  <div id="scoreBox">Score: 0<br>Combo: 0</div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const volumeSlider = document.getElementById("volume");
const judgeSlider = document.getElementById("judge");
const scoreBox = document.getElementById("scoreBox");
const hitLineY = canvas.height - 100;
const keys = ['a', 's', 'd', 'k', 'l'];
const keyPositions = {'a': 100, 's': 180, 'd': 260, 'k': 340, 'l': 420};

let isPaused = false;
let startTime = null;
let gameStarted = false;
let score = 0;
let combo = 0;

const notes = [];
for (let i = 0; i < 50; i++) {
  const time = 2 + i * 0.6;
  const key = keys[i % keys.length];
  const long = (i % 7 === 0); // every 7th note is long
  notes.push({ time, key, hit: false, long: long, duration: long ? 1.5 : 0 });
}

const hitSound = new Audio("hit.wav");
hitSound.volume = volumeSlider.value;

volumeSlider.addEventListener("input", () => {
  hitSound.volume = volumeSlider.value;
});

function togglePause() {
  isPaused = !isPaused;
}

function saveComment() {
  const c = document.getElementById("commentBox").value;
  if (c.trim()) {
    localStorage.setItem("sugarKaneComment", c);
    alert("Comment saved!");
  }
}

document.addEventListener("keydown", (e) => {
  if (!gameStarted || isPaused) return;
  const currentTime = (performance.now() - startTime) / 1000;
  const judge = parseInt(judgeSlider.value);

  notes.forEach(note => {
    if (!note.hit && note.key === e.key) {
      const y = (note.time - currentTime) * 300;
      if (Math.abs(y - hitLineY) < judge) {
        note.hit = true;
        hitSound.currentTime = 0;
        hitSound.play();
        score += 100;
        combo++;
      }
    }
  });
});

function drawHitLine() {
  ctx.strokeStyle = "gray";
  ctx.beginPath();
  ctx.moveTo(0, hitLineY);
  ctx.lineTo(canvas.width, hitLineY);
  ctx.stroke();
  keys.forEach(k => {
    ctx.fillStyle = "white";
    ctx.fillRect(keyPositions[k], hitLineY, 40, 10);
  });
}

function drawNotes(currentTime) {
  notes.forEach(note => {
    if (note.hit) return;
    const x = keyPositions[note.key];
    const y = (note.time - currentTime) * 300;
    if (y > -40 && y < canvas.height + 40) {
      ctx.fillStyle = note.long ? "yellow" : "lime";
      if (note.long) {
        const height = note.duration * 300;
        ctx.fillRect(x + 10, y, 20, height);
      } else {
        ctx.fillRect(x, y, 40, 15);
      }
    }
  });
}

function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  startTime = performance.now();
  requestAnimationFrame(gameLoop);
}

function gameLoop(timestamp) {
  if (!startTime) return;
  const currentTime = (timestamp - startTime) / 1000;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!isPaused) {
    drawHitLine();
    drawNotes(currentTime);
  }

  scoreBox.innerHTML = "Score: " + score + "<br>Combo: " + combo;
  requestAnimationFrame(gameLoop);
}

startGame();
</script>
</body>
</html>
